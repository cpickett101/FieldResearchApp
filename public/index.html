<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Research Interactive Map and Slideshow</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Exif.js for extracting image metadata -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    
    <!-- JSZip for creating KMZ files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif; 
            height: 100vh;
            overflow: hidden;
        }
        
        #container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        #map-container {
            width: 50%;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #splitter {
            width: 8px;
            height: 100%;
            background: #555;
            cursor: ew-resize;
            position: relative;
        }
        
        #splitter::after {
            content: "‚ãÆ‚ãÆ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            writing-mode: vertical-lr;
        }
        
        #image-panel {
            width: calc(50% - 8px);
            height: 100%;
            background: #f5f5f5;
            position: relative;
            overflow: hidden;
            transition: width 0.3s ease;
        }
        
        #slideshow {
            width: 100%;
            height: calc(100% - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #slideshow img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: opacity 0.5s ease;
        }
        
        #controls {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: #eee;
            border-top: 1px solid #ddd;
            padding: 0 20px;
        }
        
        .control-button {
            padding: 8px 16px;
            background: #3887BE;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-button:hover {
            background: #2a6b9c;
        }
        
        #auto-play {
            background: #28a745;
        }
        
        #auto-play.playing {
            background: #dc3545;
        }
        
        #image-info {
            position: absolute;
            bottom: 90px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #image-info.visible {
            opacity: 1;
        }
        
        #coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        #upload-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        #fullscreen-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .fullscreen #slideshow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
        }
        
        .marker-cluster {
            background-color: rgba(56, 135, 190, 0.6);
        }
        
        .marker-cluster div {
            background-color: rgba(56, 135, 190, 0.8);
            color: white;
        }
        
        .leaflet-popup-content img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3887BE;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #export-kmz {
            background-color: #4CAF50;
        }
        
        #export-kmz:hover {
            background-color: #3e8e41;
        }
        
        /* Status message */
        #status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            font-size: 16px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="map-container">
            <div id="map"></div>
        </div>
        
        <div id="splitter"></div>
        
        <div id="image-panel">
            <div id="slideshow">
                <div id="status-message">Click a marker on the map to see images</div>
                <div class="spinner"></div>
            </div>
            
            <div id="image-info"></div>
            <div id="coordinates"></div>
            
            <button id="fullscreen-button">‚õ∂</button>
            
            <div id="controls">
                <button id="prev-button" class="control-button">‚óÄ Previous</button>
                <button id="auto-play" class="control-button">‚ñ∂ Auto Play</button>
                <button id="next-button" class="control-button">Next ‚ñ∂</button>
                <div style="flex-grow: 1;"></div>
                <button id="export-kmz" class="control-button" title="Export as KMZ for Google Earth">
                    üåç Export KMZ
                </button>
                <label for="file-upload" class="control-button">
                    üì∑ Upload Images
                </label>
                <input type="file" id="file-upload" multiple style="display: none" accept="image/*">
		<div id="credits">
    			<p>Created by <a href="https://www.linkedin.com/in/christopher-p-a4908979/" target="_blank" rel="noopener noreferrer">Christopher Pickett</a> | 2025 | <a href="https://github.com/cpickett101/FieldResearchApp" target="_blank">GitHub</a></p>
		</div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the map
            const map = L.map('map').setView([40.7128, -74.0060], 4);
            
            // Add the tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Create a marker cluster group
            const markers = L.markerClusterGroup();
            map.addLayer(markers);
            
            // Create a variable to store the currently active marker
            let activeMarker = null;
            
            // Sample data (would be replaced with user data)
            const sampleLocations = [
                { coords: [37.7749, -122.4194], title: "San Francisco Field Sample", 
                  description: "Vegetation samples from Golden Gate Park", 
                  images: [
                    { url: "https://source.unsplash.com/800x600/?landscape,nature,plants,field,research", 
                      caption: "Sample 1: Native plants", date: "2024-03-10" },
                    { url: "https://source.unsplash.com/800x600/?ecology,forest,research,field", 
                      caption: "Sample 2: Soil composition", date: "2024-03-10" }
                  ]
                },
                { coords: [34.0522, -118.2437], title: "Los Angeles Research Site", 
                  description: "Urban ecology research", 
                  images: [
                    { url: "https://source.unsplash.com/800x600/?city,ecology,plants,research,urban", 
                      caption: "Urban plant adaptation", date: "2024-02-15" },
                    { url: "https://source.unsplash.com/800x600/?pollution,city,research,measurement", 
                      caption: "Air quality measurement", date: "2024-02-16" }
                  ]
                },
                { coords: [47.6062, -122.3321], title: "Seattle Wetlands Study", 
                  description: "Coastal ecosystem analysis", 
                  images: [
                    { url: "https://source.unsplash.com/800x600/?wetland,birds,research,ecology", 
                      caption: "Wetland bird species", date: "2024-01-20" },
                    { url: "https://source.unsplash.com/800x600/?marsh,plants,research,water", 
                      caption: "Marsh plant samples", date: "2024-01-21" },
                    { url: "https://source.unsplash.com/800x600/?water,quality,test,research", 
                      caption: "Water quality testing", date: "2024-01-22" }
                  ]
                }
            ];
            
            // Current slideshow state
            const state = {
                currentLocationIndex: -1,
                currentImageIndex: 0,
                locations: sampleLocations,
                isPlaying: false,
                playInterval: null,
                playSpeed: 3000 // milliseconds
            };
            
            // Add markers to the map
            function addMarkersToMap(locations) {
                markers.clearLayers();
                
                locations.forEach((location, index) => {
                    // Store the marker in the location object so we can reference it later
                    const marker = L.marker(location.coords, {
                        // Add a unique id to each marker for easier reference
                        id: `marker-${index}`
                    });
                    
                    // Add the marker reference to the location object
                    location.marker = marker;
                    
                    // Create popup content
                    const popupContent = document.createElement('div');
                    popupContent.innerHTML = `
                        <h3>${location.title}</h3>
                        <p>${location.description}</p>
                        <p><strong>${location.images.length}</strong> image(s) available</p>
                        <img src="${location.images[0].url}" alt="${location.title}">
                        <button class="view-slideshow">View Slideshow</button>
                    `;
                    
                    popupContent.querySelector('.view-slideshow').addEventListener('click', function() {
                        showLocationImages(index);
                        marker.closePopup();
                    });
                    
                    marker.bindPopup(popupContent);
                    
                    marker.on('click', function() {
                        map.flyTo(location.coords, 12);
                    });
                    
                    markers.addLayer(marker);
                });
                
                // If we have locations, update the status message
                if (locations.length > 0) {
                    document.getElementById('status-message').textContent = 'Click a marker on the map to see images';
                    document.getElementById('status-message').style.display = 'block';
                } else {
                    document.getElementById('status-message').textContent = 'Upload images to start';
                    document.getElementById('status-message').style.display = 'block';
                }
            }
            
            // Show images from a specific location
            function showLocationImages(locationIndex) {
                state.currentLocationIndex = locationIndex;
                state.currentImageIndex = 0;
                
                // Update the map view
                const location = state.locations[locationIndex];
                map.flyTo(location.coords, 13);
                
                // Highlight the active marker
                highlightActiveMarker(location);
                
                // Show the first image
                showCurrentImage();
                
                // Hide the status message
                document.getElementById('status-message').style.display = 'none';
            }
            
            // Function to highlight the active marker
            function highlightActiveMarker(location) {
                // Reset previous active marker if it exists
                if (activeMarker) {
                    // Remove the active class by resetting the icon
                    activeMarker.setIcon(L.icon({
                        iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
                        shadowSize: [41, 41]
                    }));
                }
                
                // Set the new active marker
                activeMarker = location.marker;
                
                // Change the icon to a highlighted version
                if (activeMarker) {
                    activeMarker.setIcon(L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
                        shadowSize: [41, 41]
                    }));
                    
                    // Make sure the marker is visible (not clustered)
                    markers.zoomToShowLayer(activeMarker, function() {
                        // Optionally open a popup or do other actions after zooming
                    });
                }
            }
            
            // Show the current image in the slideshow
            function showCurrentImage() {
                if (state.currentLocationIndex === -1) return;
                
                const slideshow = document.getElementById('slideshow');
                const imageInfo = document.getElementById('image-info');
                const coordinatesElement = document.getElementById('coordinates');
                
                // Remove existing images
                const existingImg = slideshow.querySelector('img');
                if (existingImg) {
                    existingImg.style.opacity = 0;
                    setTimeout(() => {
                        existingImg.remove();
                        showNewImage();
                    }, 300);
                } else {
                    showNewImage();
                }
                
                function showNewImage() {
                    const location = state.locations[state.currentLocationIndex];
                    const image = location.images[state.currentImageIndex];
                    
                    // Create and add the new image
                    const img = new Image();
                    img.style.opacity = 0;
                    img.src = image.url;
                    img.alt = image.caption;
                    
                    img.onload = function() {
                        img.style.opacity = 1;
                    };
                    
                    slideshow.appendChild(img);
                    
                    // Update image info
                    imageInfo.innerHTML = `
                        <strong>${location.title}</strong><br>
                        ${image.caption}<br>
                        <small>Date: ${image.date}</small><br>
                        <small>Image ${state.currentImageIndex + 1} of ${location.images.length}</small>
                    `;
                    
                    imageInfo.classList.add('visible');
                    
                    // Format and display coordinates
                    const lat = location.coords[0].toFixed(6);
                    const lng = location.coords[1].toFixed(6);
                    coordinatesElement.textContent = `Coordinates: ${lat}, ${lng}`;
                    coordinatesElement.style.display = 'block';
                    
                    // Make sure the correct marker is highlighted
                    highlightActiveMarker(location);
                }
            }
            
            // Navigate to the next image
            function showNextImage() {
                if (state.currentLocationIndex === -1) return;
                
                const location = state.locations[state.currentLocationIndex];
                state.currentImageIndex = (state.currentImageIndex + 1) % location.images.length;
                showCurrentImage();
            }
            
            // Navigate to the previous image
            function showPreviousImage() {
                if (state.currentLocationIndex === -1) return;
                
                const location = state.locations[state.currentLocationIndex];
                state.currentImageIndex = (state.currentImageIndex - 1 + location.images.length) % location.images.length;
                showCurrentImage();
            }
            
            // Toggle auto-play functionality
            function toggleAutoPlay() {
                const autoPlayButton = document.getElementById('auto-play');
                
                if (state.isPlaying) {
                    clearInterval(state.playInterval);
                    state.isPlaying = false;
                    autoPlayButton.textContent = '‚ñ∂ Auto Play';
                    autoPlayButton.classList.remove('playing');
                } else {
                    if (state.currentLocationIndex !== -1) {
                        state.isPlaying = true;
                        autoPlayButton.textContent = '‚è∏ Stop';
                        autoPlayButton.classList.add('playing');
                        
                        state.playInterval = setInterval(() => {
                            showNextImage();
                        }, state.playSpeed);
                    }
                }
            }
            
            // Handle image uploads
            function handleImageUpload(files) {
                if (files.length === 0) return;
                
                const spinner = document.querySelector('.spinner');
                spinner.style.display = 'block';
                
                const statusMessage = document.getElementById('status-message');
                statusMessage.textContent = `Processing ${files.length} images...`;
                statusMessage.style.display = 'block';
                
                // We'll store the new locations here
                const newLocations = [];
                let processedFiles = 0;
                
                // Process each file
                Array.from(files).forEach(file => {
                    // Read the file
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = new Image();
                        img.src = e.target.result;
                        
                        img.onload = function() {
                            // Try to extract GPS data using EXIF.js
                            EXIF.getData(img, function() {
                                let coords = null;
                                let lat = EXIF.getTag(this, "GPSLatitude");
                                let lng = EXIF.getTag(this, "GPSLongitude");
                                let latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                                let lngRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";
                                
                                if (lat && lng) {
                                    lat = convertDMSToDD(lat, latRef);
                                    lng = convertDMSToDD(lng, lngRef);
                                    coords = [lat, lng];
                                } else {
                                    // If no GPS data, use a random location for demo purposes
                                    // In a real app, you'd prompt the user to select a location
                                    coords = [
                                        40.7128 + (Math.random() - 0.5) * 10,
                                        -74.0060 + (Math.random() - 0.5) * 10
                                    ];
                                }
                                
                                // Get the date if available
                                let date = EXIF.getTag(this, "DateTimeOriginal");
                                if (!date) {
                                    date = new Date().toISOString().split('T')[0];
                                } else {
                                    date = date.split(' ')[0].replace(/:/g, '-');
                                }
                                
                                // Check if we already have a location with these coords
                                let locationIndex = newLocations.findIndex(loc => 
                                    Math.abs(loc.coords[0] - coords[0]) < 0.001 &&
                                    Math.abs(loc.coords[1] - coords[1]) < 0.001
                                );
                                
                                const imageData = {
                                    url: e.target.result,
                                    caption: file.name.replace(/\.[^/.]+$/, ""),
                                    date: date
                                };
                                
                                if (locationIndex === -1) {
                                    // Create a new location
                                    newLocations.push({
                                        coords: coords,
                                        title: `Research Site ${newLocations.length + 1}`,
                                        description: `Uploaded on ${new Date().toLocaleDateString()}`,
                                        images: [imageData]
                                    });
                                } else {
                                    // Add to existing location
                                    newLocations[locationIndex].images.push(imageData);
                                }
                                
                                processedFiles++;
                                
                                // When all files are processed
                                if (processedFiles === files.length) {
                                    // Add new locations to the state
                                    state.locations = [...state.locations, ...newLocations];
                                    
                                    // Update markers on the map
                                    addMarkersToMap(state.locations);
                                    
                                    // Hide spinner and show success message
                                    spinner.style.display = 'none';
                                    statusMessage.textContent = `Added ${files.length} images to the map`;
                                    setTimeout(() => {
                                        statusMessage.style.display = 'none';
                                    }, 3000);
                                    
                                    // If this is the first upload, show the first location
                                    if (state.currentLocationIndex === -1 && state.locations.length > 0) {
                                        showLocationImages(state.locations.length - newLocations.length);
                                    }
                                }
                            });
                        };
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            // Convert EXIF DMS coordinates to decimal degrees
            function convertDMSToDD(coordinates, direction) {
                const degrees = coordinates[0];
                const minutes = coordinates[1];
                const seconds = coordinates[2];
                
                let dd = degrees + minutes/60 + seconds/3600;
                
                if (direction === "S" || direction === "W") {
                    dd = -dd;
                }
                
                return dd;
            }
            
            // Fullscreen mode toggle
            function toggleFullscreen() {
                const slideshow = document.getElementById('slideshow');
                
                if (slideshow.classList.contains('fullscreen')) {
                    slideshow.classList.remove('fullscreen');
                    document.getElementById('fullscreen-button').textContent = '‚õ∂';
                } else {
                    slideshow.classList.add('fullscreen');
                    document.getElementById('fullscreen-button').textContent = '‚õî';
                }
            }
            
            // Draggable splitter functionality
            function initSplitter() {
                const splitter = document.getElementById('splitter');
                const mapContainer = document.getElementById('map-container');
                const imagePanel = document.getElementById('image-panel');
                let isDragging = false;
                
                splitter.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    isDragging = true;
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    const containerWidth = document.getElementById('container').offsetWidth;
                    const newMapWidth = e.clientX;
                    const newImageWidth = containerWidth - newMapWidth - splitter.offsetWidth;
                    
                    // Enforce minimum widths
                    if (newMapWidth < 200 || newImageWidth < 200) return;
                    
                    mapContainer.style.width = newMapWidth + 'px';
                    imagePanel.style.width = newImageWidth + 'px';
                    
                    // Update the map to prevent grey areas
                    map.invalidateSize();
                });
                
                document.addEventListener('mouseup', function() {
                    isDragging = false;
                });
            }
            
            // Create a thumbnail version of an image
            function createThumbnail(imageUrl, maxWidth = 200, maxHeight = 150) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous"; // Handle CORS issues
                    
                    img.onload = function() {
                        // Calculate new dimensions while maintaining aspect ratio
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        // Create canvas and draw the image at the new size
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        // Use bicubic interpolation for better quality at smaller sizes
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 data URL with better quality
                        try {
                            const thumbnailData = canvas.toDataURL('image/jpeg', 0.8);
                            resolve(thumbnailData);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('Failed to load image for thumbnail'));
                    };
                    
                    img.src = imageUrl;
                });
            }
            
            // Create an optimized version of the full image
            function optimizeImage(imageUrl, maxWidth = 1200, maxHeight = 900, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous"; // Handle CORS issues
                    
                    img.onload = function() {
                        // Only resize if the image is larger than our max dimensions
                        let width = img.width;
                        let height = img.height;
                        let shouldResize = width > maxWidth || height > maxHeight;
                        
                        if (shouldResize) {
                            // Calculate new dimensions while maintaining aspect ratio
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round(height * maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round(width * maxHeight / height);
                                    height = maxHeight;
                                }
                            }
                        }
                        
                        // Create canvas and draw the image (resized if necessary)
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 data URL with controlled quality
                        try {
                            const optimizedData = canvas.toDataURL('image/jpeg', quality);
                            resolve(optimizedData);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('Failed to load image for optimization'));
                    };
                    
                    img.src = imageUrl;
                });
            }
            
            // Export KMZ file for Google Earth
            async function exportKMZ() {
                if (state.locations.length === 0) {
                    alert('No data to export. Please upload images first.');
                    return;
                }
                
                // Show spinner and status message
                const spinner = document.querySelector('.spinner');
                spinner.style.display = 'block';
                
                const statusMessage = document.getElementById('status-message');
                statusMessage.textContent = 'Creating KMZ file...';
                statusMessage.style.display = 'block';
                
                try {
                    // Create a new JSZip instance
                    const zip = new JSZip();
                    
                    // Start building the KML content
                    let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:gx="http://www.google.com/kml/ext/2.2">
    <Document>
        <name>Field Research Data</name>
        <description>Exported from Field Research Map Application</description>
        <Style id="highlightedPin">
            <IconStyle>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
                </Icon>
            </IconStyle>
        </Style>`;
                    
                    // Process each location
                    for (let i = 0; i < state.locations.length; i++) {
                        const location = state.locations[i];
                        
                        // Add a folder for each location
                        kmlContent += `
        <Folder>
            <name>${location.title}</name>
            <description>${location.description}</description>`;
                        
                        // Process each image in the location
                        for (let j = 0; j < location.images.length; j++) {
                            const image = location.images[j];
                            const imageFileName = `images/location${i}_image${j}.jpg`;
                            const thumbnailFileName = `images/location${i}_image${j}_thumb.jpg`;
                            
                            // Create thumbnail
                            try {
                                // Add the original image to the zip
                                // For base64 data URLs, we need to extract the actual base64 data
                                if (image.url.startsWith('data:')) {
                                    const imageData = image.url.split(',')[1];
                                    zip.file(imageFileName, imageData, {base64: true});
                                    
                                    // Create and add thumbnail
                                    const thumbnailData = await createThumbnail(image.url);
                                    const thumbnailBase64 = thumbnailData.split(',')[1];
                                    zip.file(thumbnailFileName, thumbnailBase64, {base64: true});
                                } else {
                                    // For regular URLs, we need to fetch the image first
                                    // This part is simplified and might need CORS handling in a real app
                                    const response = await fetch(image.url);
                                    const blob = await response.blob();
                                    zip.file(imageFileName, blob);
                                    
                                    // Create and add thumbnail
                                    const thumbnailData = await createThumbnail(image.url);
                                    const thumbnailBase64 = thumbnailData.split(',')[1];
                                    zip.file(thumbnailFileName, thumbnailBase64, {base64: true});
                                }
                                
                                // Add placemark for this image
                                kmlContent += `
            <Placemark>
                <name>${image.caption}</name>
                <description>
                    <![CDATA[
                    <h3>${image.caption}</h3>
                    <p>Date: ${image.date}</p>
                    <img src="${thumbnailFileName}" width="200" /><br/>
                    <a href="${imageFileName}">View full-size image</a>
                    ]]>
                </description>
                <styleUrl>#highlightedPin</styleUrl>
                <Point>
                    <coordinates>${location.coords[1]},${location.coords[0]},0</coordinates>
                </Point>
            </Placemark>`;
                            } catch (error) {
                                console.error('Error processing image:', error);
                                // Continue with the next image
                            }
                        }
                        
                        // Close the folder
                        kmlContent += `
        </Folder>`;
                    }
                    
                    // Close the KML document
                    kmlContent += `
    </Document>
</kml>`;
                    
                    // Add the KML file to the zip
                    zip.file("doc.kml", kmlContent);
                    
                    // Generate the KMZ file
                    const kmzContent = await zip.generateAsync({type: 'blob'});
                    
                    // Save the file using FileSaver.js
                    saveAs(kmzContent, "field_research_data.kmz");
                    
                    // Hide spinner and show success message
                    spinner.style.display = 'none';
                    statusMessage.textContent = 'KMZ file created successfully';
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error creating KMZ file:', error);
                    
                    // Hide spinner and show error message
                    spinner.style.display = 'none';
                    statusMessage.textContent = 'Error creating KMZ file: ' + error.message;
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Initialize the application
            function init() {
                // Add the sample markers to the map
                addMarkersToMap(state.locations);
                
                // Initialize the splitter
                initSplitter();
                
                // Event listeners
                document.getElementById('prev-button').addEventListener('click', showPreviousImage);
                document.getElementById('next-button').addEventListener('click', showNextImage);
                document.getElementById('auto-play').addEventListener('click', toggleAutoPlay);
                document.getElementById('fullscreen-button').addEventListener('click', toggleFullscreen);
                document.getElementById('export-kmz').addEventListener('click', exportKMZ);
                
                // File upload handling
                document.getElementById('file-upload').addEventListener('change', function(e) {
                    handleImageUpload(e.target.files);
                });
                
                // Map resize event
                window.addEventListener('resize', function() {
                    map.invalidateSize();
                });
                
                // Check for offline capability
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/service-worker.js')
                            .then(registration => {
                                console.log('ServiceWorker registered');
                            })
                            .catch(error => {
                                console.log('ServiceWorker registration failed: ', error);
                            });
                    });
                }
            }
            
            // Start the application
            init();
        });
    </script>
</body>
</html>
